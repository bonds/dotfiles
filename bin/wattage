#!/usr/bin/env fish

argparse v/verbose -- $argv

# HOST=$(arp -a | grep -i "24:2F:D0:26:02:C9" | sed 's/\? (\(.*\)).*/\1/g')
# the outlet doesn't always respond to ARP so I'm just going to give it an
# IP reservation so it gets the same IP from DHCP every time

set WORKSTATION "10.0.0.75"
set SERVERRACK "10.0.0.189"

set hosts $WORKSTATION $SERVERRACK
set names workstation servers

for i in (seq (count $hosts))
    if not set -q _flag_verbose
        set longest (string length $names | sort -n | tail -1)
        set width (bc -e "$longest + 5")
        set watts (kasa --host $hosts[$i] emeter $argv | grep Power | awk '{printf "%.f", $2}')
        string pad --width $width "$names[$i]: $(string pad --width 3 $watts)"
    else
        echo $names[$i]
        kasa --host $hosts[$i] emeter $argv
        echo
    end
end
